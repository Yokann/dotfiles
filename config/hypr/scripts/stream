#!/bin/bash

if [[ "$OSTYPE" == "darwin"* ]]; then
    twitch_cli_config_path="$HOME/Library/Application Support/twitch-cli"
elif [[ "$OSTYPE" == "linux"* ]]; then
    twitch_cli_config_path="$HOME/.config/twitch-cli"
else
    exit 1
fi

function opterr() { 
    echo >&2 "stream: Unknown option '$1'" 
}

chat="false"
video="true"
menu="false"
while (( $# )); do
    case $1 in
        -c|--chat)          chat="true"                  ;;
        -n|--no-video)      video="false"                ;;
        -m|--dmenu)         menu="true"                  ;;
        -*)                 opterr $1 && return 2        ;;
        *)                  selected_channel=$1; break   ;;
    esac
    shift
done

if [ -z "$selected_channel" ]; then
    live_channels=$($HYPR_CONFIG_PATH/scripts/twitch_live_channels)

    if [ $menu == "true" ]; then
        selected_channel=$(echo $live_channels | jq -r '.[] | .user_name' | walker -d)
    else
        selected_channel=$(echo $live_channels | jq -r '.[] | [.user_name, .title] | @csv' | gum table -c "Channel,Title" -w "20,200" | cut -d',' -f1)
    fi
fi

# Prompt to choose a channel
if [ -z "$selected_channel" ]; then
    echo "No live channel selected"
    exit 1
fi

source "$twitch_cli_config_path/.twitch-cli.env" 2> /dev/null  # source to load ACCESSTOKEN as a variable
if [ $video == "true" ]; then
    echo "Lauching stream of $selected_channel"
    streamlink -Q "--twitch-api-header=Authorization=Bearer $ACCESSTOKEN" https://www.twitch.tv/$selected_channel &
fi

if [ $chat == "true" ]; then
    # echo "oauth:$ACCESSTOKEN"
    TWT_TOKEN="oauth:$ACCESSTOKEN" twt -c $selected_channel
fi
